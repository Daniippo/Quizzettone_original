<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Didattica Hub - Sfida Achille e la Tartaruga</title>

  <meta name="author" content="Daniela Ippolito (@matefacile)">
  <meta name="copyright" content="¬© Daniela Ippolito (@matefacile)">

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#bfa100">
  <link rel="apple-touch-icon" href="icon-512.png">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script>
    window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] } };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root {
      --c-oro: #bfa100;
      --c-accento: #27ae60;
      --c-sfondo: #fdfbf7;
      --c-testo: #2c3e50;
      --c-errore: #e74c3c;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; font-family: 'Inter', sans-serif; 
      background: var(--c-sfondo); color: var(--c-testo); 
      display: flex; flex-direction: column; min-height: 100vh;
      overflow-x: hidden;
    }

    /* BARRA PUNTEGGIO */
    #stars-bar {
      position: fixed; top: 20px; right: 20px;
      background: white; padding: 8px 15px; border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      z-index: 2000; display: flex; align-items: center; gap: 8px;
      font-weight: bold; color: var(--c-oro); border: 2px solid var(--c-oro);
    }

    /* ANIMAZIONI RISPOSTE */
    .flying-star {
      position: fixed; z-index: 9999; font-size: 24px;
      transition: all 0.8s cubic-bezier(0.6, -0.28, 0.735, 0.045);
      pointer-events: none;
    }
    .exploding-poop {
      position: fixed; z-index: 9999; font-size: 30px;
      animation: poop-fade 0.6s forwards;
      pointer-events: none;
    }
    @keyframes poop-fade {
      0% { transform: scale(0.5); opacity: 0; }
      20% { transform: scale(1.2); opacity: 1; }
      100% { transform: translateY(20px) scale(1); opacity: 0; }
    }

    /* === LAYOUT MENU A GRIGLIA === */
    #menu-screen { 
      padding: 40px 20px; 
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }
    .logo-area { text-align: center; margin-bottom: 30px; }
    .logo-area h1 { font-family: 'Cinzel', serif; color: var(--c-oro); font-size: 2rem; margin: 0; }
    
    #sfide-list { 
      display: grid !important; 
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)) !important; 
      gap: 20px !important; 
      width: 100% !important;
      margin-top: 30px;
    }
    
    .sfida-card { 
      background: white; 
      padding: 18px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      cursor: pointer; 
      border-top: 6px solid var(--c-oro);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      height: 160px; /* Altezza uniforme */
      text-align: left;
    }
    .sfida-card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    .sfida-card h2 { margin: 0 0 10px 0; font-size: 1.15rem; color: var(--c-testo); line-height: 1.2; }
    .sfida-card p { margin: 0; font-size: 0.85rem; color: #666; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }

    /* LAYOUT GIOCO */
    #game-screen { display: none; flex-grow: 1; }
    .header {
      padding: 15px;
      border-bottom: 3px solid var(--c-oro);
      background: white;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .back-btn { background: none; border: none; font-size: 1.5rem; color: var(--c-oro); cursor: pointer; }

    #main-game-area { padding: 40px 0; }

    .vertical-track {
      position: relative;
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .node-container { width: 100%; position: relative; z-index: 2; display: flex; margin: 18px 0; justify-content: center; }

    /* Zig-Zag */
    .node-container:nth-child(8n+1) { transform: translateX(-110px); }
    .node-container:nth-child(8n+2) { transform: translateX(-60px); }
    .node-container:nth-child(8n+3) { transform: translateX(60px); }
    .node-container:nth-child(8n+4) { transform: translateX(110px); }
    .node-container:nth-child(8n+5) { transform: translateX(110px); }
    .node-container:nth-child(8n+6) { transform: translateX(60px); }
    .node-container:nth-child(8n+7) { transform: translateX(-60px); }
    .node-container:nth-child(8n+8) { transform: translateX(-110px); }

    .node {
      width: 55px; height: 55px; border-radius: 50%;
      background: white; border: 4px solid var(--c-oro);
      display: flex; justify-content: center; align-items: center;
      cursor: pointer; font-weight: bold;
      box-shadow: 0 4px 0 #ddd; transition: 0.2s;
    }
    .node.done { background: var(--c-accento); color: white; border-color: #1e8449; box-shadow: 0 4px 0 #1e8449; }
    .node.future { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }

    /* Avatar: ora si muove con transform (pi√π stabile) */
    .avatar {
      position: absolute;
      font-size: 38px;
      z-index: 10;
      transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: none;
      top: 0; left: 0;
    }

    #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 3000; }
    #modal-content { background: white; padding: 25px; border-radius: 20px; width: 92%; max-width: 500px; text-align: center; max-height: 85vh; overflow-y: auto; }
    
    .btn-ans { background: var(--c-oro); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; margin: 10px auto; width: 100%; display: block; font-size: 1rem; }

    #report-area { display: none; padding: 20px; background: white; text-align: center; }
    .report-table-container { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: top; }
    th { background: var(--c-oro); color: white; }
    .theory-text { font-size: 0.85rem; color: #555; font-style: italic; display: block; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }

    @media print {
      .no-print, #stars-bar, .header, .btn-ans, #menu-screen, #game-screen { display: none !important; }
      #report-area { display: block !important; }
    }

    /* === BRAND / COPYRIGHT (Matefacile) === */
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #666;
      font-size: 0.82rem;
      line-height: 1.2;
    }
    .brand img {
      width: 28px;
      height: 28px;
      object-fit: contain;
      border-radius: 6px;
    }
    .brand .brand-text strong { color: var(--c-testo); }

    .brand-home { justify-content: center; margin-top: 10px; }
    .brand-report { justify-content: center; margin: 8px 0 18px 0; }
    .brand-header { margin-left: auto; margin-right: 10px; white-space: nowrap; }

    @media (max-width: 420px){
      .brand-header .brand-text { display: none; } /* in header resta solo il logo */
    }

    @media print {
      .brand-header, .brand-home { display: none !important; }
      .brand-report { display: flex !important; }
    }
/* === LANGUAGE TOGGLE === */
.lang-toggle{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-top:12px;
  position: sticky;
  top: 10px;
  z-index: 1500;
}

.lang-btn{
  border: 2px solid var(--c-oro);
  background: #fff;
  color: var(--c-testo);
  padding: 10px 14px;
  border-radius: 999px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  min-width: 160px;
}

.lang-btn.active{
  background: var(--c-oro);
  color: #fff;
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.14);
}

.lang-btn:active{
  transform: translateY(0);
}






    
  </style>
</head>

<body>

  <div id="stars-bar">
    <span>‚≠ê</span>
    <span id="stars-count">0</span>
  </div>

  <div id="menu-screen">
    <div class="logo-area">
      <h1>Didattica Hub</h1>
      <div id="brand-home"></div>
    </div>
<!-- SWITCH LINGUA -->
<div class="no-print lang-toggle">
  <button id="btn-lang-it" class="lang-btn" onclick="setLang('it')">üáÆüáπ Italiano</button>
  <button id="btn-lang-en" class="lang-btn" onclick="setLang('en')">üá¨üáß English</button>
</div>


    <div id="sfide-list">Caricamento sfide...</div>
    <div style="text-align: center;">
      <button class="btn-ans no-print" style="background:#7f8c8d; max-width:180px; margin-top:30px;" onclick="resetTutto()">RESET GLOBALE</button>
    </div>
  </div>

  <div id="game-screen">
    <div class="header no-print">
      <button class="back-btn" onclick="tornaAlMenu()">‚ùÆ</button>

      <div style="text-align:center; flex:1;">
        <h1 id="topic-title" style="font-family:'Cinzel'; font-size:1rem; margin:0; color:var(--c-oro)">...</h1>
        <small id="progress-text">0/0 completati</small>
      </div>

      <div id="brand-header"></div>

      <button class="back-btn" onclick="resetGame()">üîÑ</button>
    </div>

    <div id="main-game-area">
      <div class="vertical-track">
        <div id="achilles" class="avatar">üèÉ‚Äç‚ôÇÔ∏è</div>
        <div id="tortoise" class="avatar">üê¢</div>
        <div id="nodes-container" style="width:100%"></div>
      </div>
    </div>
  </div>

  <div id="report-area">
    <h1 id="report-title" style="font-family:'Cinzel'; color: var(--c-oro);"></h1>
    <div id="brand-report"></div>
   <h2 id="final-stars"></h2>

    <div class="report-table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th id="th-question"></th>
            <th id="th-correct"></th>
            <th id="th-attempts"></th>
          </tr>
        </thead>
        <tbody id="report-body"></tbody>
      </table>
    </div>

    <div class="no-print">
      <button class="btn-ans" style="display:inline-block; width:auto; padding: 10px 30px; margin-top: 20px;" onclick="window.print()">üñ®Ô∏è STAMPA REPORT</button>
      <button class="btn-ans" style="display:inline-block; width:auto; background:#7f8c8d; padding: 10px 30px;" onclick="tornaAlMenu()">üè† HOME</button>
    </div>
  </div>

  <div id="modal-overlay">
    <div id="modal-content">
      <div id="quiz-container"></div>
      <div id="feedback-msg"></div>
    </div>
  </div>

  <audio id="snd-ok" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
  <audio id="snd-no" src="https://www.myinstants.com/media/sounds/raspberry.mp3"></audio>

  <script>
    const URL_INDICE_SFIDE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo9ZeS6loicyVFU04pA29n5GxEeg3q7teyh2-Tsd4DUPzwjNyQsPE4OBwG7WF14rSdxbPeTn594i1D/pub?gid=892603852&single=true&output=csv";
/* === MULTILINGUA === */
let LANG = localStorage.getItem("lang") || "it"; // default: IT

function updateLangUI() {
  const bIt = document.getElementById("btn-lang-it");
  const bEn = document.getElementById("btn-lang-en");
  if (!bIt || !bEn) return;

  bIt.classList.toggle("active", LANG === "it");
  bEn.classList.toggle("active", LANG === "en");
}

function setLang(l) {
  LANG = l;
  localStorage.setItem("lang", LANG);
  updateLangUI();
  renderMenu();
}


/* === TRADUZIONI UI === */
const I18N = {
  it: {
    loading: "Caricamento sfide...",
    indexError: "Errore indice",
    question: "Domanda",
    correct: "‚ú® Corretto!",
    wrong: "‚ùå Errato!",
    attempt: "Tentativo",
    attempts: "Tentativi",
    continue: "PROSEGUI",
    finalReport: "Report Finale",
    totalStars: "Stelle Finali",
    print: "STAMPA REPORT",
    home: "HOME",
    resetAll: "RESET TOTALE",
    loadingChallengeError: "Errore caricamento sfida.",
    reportQuestion: "Domanda",
    reportCorrect: "Risposta corretta",
    reportAttempts: "Tentativi"
  },

  en: {
    loading: "Loading challenges...",
    indexError: "Index error",
    question: "Question",
    correct: "‚ú® Correct!",
    wrong: "‚ùå Wrong!",
    attempt: "Attempt",
    attempts: "Attempts",
    continue: "CONTINUE",
    finalReport: "Final Report",
    totalStars: "Final Stars",
    print: "PRINT REPORT",
    home: "HOME",
    resetAll: "RESET ALL",
    loadingChallengeError: "Error loading challenge.",
    reportQuestion: "Question",
    reportCorrect: "Correct Answer",
    reportAttempts: "Attempts"
  }
};

function t(key) {
  return I18N[LANG]?.[key] || I18N.it[key] || key;
}

let SFIDE_CARICATE = [];
let currentSfida = null;
let adventData = [];
let TOTAL_LEVELS = 0;
let stars = 0;

const BRAND = {
  name: "Daniela Ippolito",
  handle: "@matefacile",
  logo: "assets/logo-matefacile.png",
  year: new Date().getFullYear()
};

    function renderBrand(targetId, variant) {
      const el = document.getElementById(targetId);
      if (!el) return;

      const cls =
        variant === "home" ? "brand brand-home" :
        variant === "header" ? "brand brand-header" :
        variant === "report" ? "brand brand-report" :
        "brand";

      el.innerHTML = `
        <div class="${cls}">
          <img src="${BRAND.logo}" alt="Matefacile">
          <div class="brand-text">
            Creato da <strong>${BRAND.name}</strong> ¬∑ ${BRAND.handle} ¬∑ ¬© ${BRAND.year}
          </div>
        </div>
      `;
    }



    /* --- INIZIALIZZAZIONE --- */
    async function init() {
      renderBrand("brand-home", "home");
      renderBrand("brand-header", "header");
      renderBrand("brand-report", "report");

      try {
        const resp = await fetch(URL_INDICE_SFIDE);
        const csv = await resp.text();
        const rows = parseCSV(csv);
         const objs = rowsToObjects(rows);
        


SFIDE_CARICATE = objs.map(o => ({
  id: o.ID,

  titolo_it: o.titolo_it,
  desc_it: o.desc_it,
  url_it: o.url_it,
  colore: o.colore || "#bfa100",

  titolo_en: o.titolo_en,
  desc_en: o.desc_en,
  url_en: o.url_en,

  image_url: o.image_url,
  enabled: (o.enabled || "").toLowerCase() === "true"
        || (o.enabled || "").toLowerCase() === "yes"
        || (o.enabled || "").toLowerCase() === "si"
        || o.enabled === "1",
  materia: o.Materia
}));

console.log("SFIDE_CARICATE:", SFIDE_CARICATE);

        renderMenu();
     } catch (e) {
  document.getElementById('sfide-list').innerText = "Errore indice: " + (e?.message || e);
  console.error("Errore indice:", e);
}

    }

    /* --- MENU --- */
    function renderMenu() {
  document.getElementById('report-area').style.display = 'none';
  document.getElementById('game-screen').style.display = 'none';
  document.getElementById('menu-screen').style.display = 'block';

  const list = document.getElementById('sfide-list');
  list.innerHTML = '';

  SFIDE_CARICATE.forEach(s => {
    // nascondi sfide disabilitate (colonna enabled)
    if (!s.enabled) return;

    const hasEN = s.url_en && s.url_en.trim() !== "";
    // in EN mostra solo quelle tradotte
    if (LANG === "en" && !hasEN) return;

    const titolo = (LANG === "en") ? (s.titolo_en || s.titolo_it) : s.titolo_it;
    const desc   = (LANG === "en") ? (s.desc_en   || s.desc_it)   : s.desc_it;

    const card = document.createElement('div');
    card.className = 'sfida-card';
    card.style.borderTopColor = s.colore;
    card.onclick = () => caricaSfida(s);

    card.innerHTML = `
      <h2 style="color:${s.colore}">${titolo}</h2>
      <p>${desc}</p>
    `;

    list.appendChild(card);
  });

  document.getElementById('stars-bar').style.display = 'none';
}

    /* --- CARICAMENTO SFIDA --- */
    async function caricaSfida(sfida) {
      currentSfida = sfida;
      document.documentElement.style.setProperty('--c-oro', sfida.colore);

      stars = parseInt(localStorage.getItem('stars_' + sfida.id)) || 0;
      document.getElementById('stars-count').innerText = stars;

      document.getElementById('stars-bar').style.display = 'flex';
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
     document.getElementById('topic-title').innerText =
  (LANG === "en") ? (sfida.titolo_en || sfida.titolo_it) : sfida.titolo_it;



      try {
        const urlSfida = (LANG === "en" && sfida.url_en && sfida.url_en.trim() !== "")
  ? sfida.url_en
  : sfida.url_it;

const resp = await fetch(urlSfida);

        const csv = await resp.text();
        const rows = parseCSV(csv);
        TOTAL_LEVELS = parseInt(rows[1][1]) || 0;

        adventData = rows.slice(4, 4 + TOTAL_LEVELS).map((v, i) => ({
          day: i + 1,
          question: v[1],
          checkAnswer: v[2],
          answerOK: v[10],
          options: [v[3], v[4], v[5], v[6], v[7]].filter(o => o && o !== ""),
          spiegazione: v[12]
        }));

        render();
      } catch (e) {
        alert(t("loadingChallengeError"));
        console.error(e);
        tornaAlMenu();
      }
    }

    /* --- RENDERING GIOCO --- */
    function render() {
      const container = document.getElementById('nodes-container');
      container.innerHTML = '';
      let solved = 0;

      adventData.forEach((d, i) => {
        const day = i + 1;
        const isDone = localStorage.getItem('day_' + currentSfida.id + '_' + day) === 'correct';
        if (isDone) solved++;

        const isFuture = (day > 1 && localStorage.getItem('day_' + currentSfida.id + '_' + (day - 1)) !== 'correct');

        const wrapper = document.createElement('div');
        wrapper.className = 'node-container';
        wrapper.innerHTML =
          '<div id="node-' + day + '" class="node ' +
          (isDone ? 'done' : (isFuture ? 'future' : '')) +
          '" onclick="' + (isFuture ? '' : 'openQuiz(' + day + ')') + '">' +
          (isDone ? '‚úî' : day) +
          '</div>';

        container.appendChild(wrapper);
      });

      document.getElementById('progress-text').innerText = solved + '/' + TOTAL_LEVELS;

      muoviPersonaggi(solved);

      if (window.MathJax) MathJax.typeset();
      if (solved === TOTAL_LEVELS && TOTAL_LEVELS > 0) setTimeout(showReport, 1500);
    }

    /* === MOVIMENTO AVATAR (FIX) === */
    function muoviPersonaggi(solved) {
      setTimeout(() => {
        const achIndex = Math.min(solved + 1, TOTAL_LEVELS);
        const tortIndex = Math.min(solved + 2, TOTAL_LEVELS);

        const achNode = document.getElementById('node-' + achIndex);
        const tortNode = document.getElementById('node-' + tortIndex);

        const track = document.querySelector('.vertical-track');
        if (!track) return;
        const trackRect = track.getBoundingClientRect();

        if (achNode) moveAvatar('achilles', achNode, trackRect);
        if (tortNode) moveAvatar('tortoise', tortNode, trackRect);
      }, 150);
    }

    function moveAvatar(id, node, trackRect) {
      const avatar = document.getElementById(id);
      if (!avatar) return;

      const nodeRect = node.getBoundingClientRect();

      const x = (nodeRect.left - trackRect.left) + (nodeRect.width / 2) - (avatar.offsetWidth / 2);
      const y = (nodeRect.top - trackRect.top) - avatar.offsetHeight + 10;

      avatar.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
    }

    /* --- GESTIONE QUIZ --- */
    function openQuiz(day) {
      const d = adventData[day - 1];
      const cont = document.getElementById('quiz-container');
      document.getElementById('feedback-msg').innerText = "";

      let h = '<h3>' + t("question") + ' ' + day + '</h3><p style="font-weight:700;">' + d.question + '</p>';

      if (d.options.length > 0) {
        d.options.forEach((o, i) => {
          h += '<button class="btn-ans" style="background:#fff; color:#333; border:2px solid #eee;" onclick="check(' + day + ', \'' + String.fromCharCode(64 + i + 1) + '\', this)">' +
               String.fromCharCode(64 + i + 1) + '. ' + o +
               '</button>';
        });
      } else {
        h += '<input type="text" id="ans" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px;">' +
             '<button class="btn-ans" onclick="check(' + day + ', document.getElementById(\'ans\').value, this)">INVIA</button>';
      }

      cont.innerHTML = h;
      document.getElementById('modal-overlay').style.display = 'flex';
      if (window.MathJax) MathJax.typeset();
    }

    function check(day, val, btn) {
      const d = adventData[day - 1];
      const sId = currentSfida.id;
      let att = (parseInt(localStorage.getItem('tent_' + sId + '_' + day)) || 0) + 1;
      localStorage.setItem('tent_' + sId + '_' + day, att);

      if (val.trim().toLowerCase() === d.checkAnswer.toLowerCase()) {
        document.getElementById('snd-ok').play().catch(() => {});
        localStorage.setItem('day_' + sId + '_' + day, 'correct');
        animateCorrectStar(btn);
      document.getElementById('quiz-container').innerHTML =
  '<h2>' + t("correct") + '</h2>' +
  '<p>' + (d.spiegazione || '') + '</p>' +
  '<button class="btn-ans" onclick="chiudiEProsegui()">' + t("continue") + '</button>';


        if (window.MathJax) MathJax.typeset();
      } else {
        document.getElementById('snd-no').play().catch(() => {});
        animatePoop(btn);
        document.getElementById('feedback-msg').innerText =
  t("wrong") + " " + t("attempt") + " n. " + att;

      }
    }

    /* --- ANIMAZIONI --- */
    function animateCorrectStar(btn) {
      const star = document.createElement('div');
      star.className = 'flying-star';
      star.innerText = '‚≠ê';
      const rect = btn.getBoundingClientRect();
      star.style.left = (rect.left + rect.width / 2) + 'px';
      star.style.top = rect.top + 'px';
      document.body.appendChild(star);

      const target = document.getElementById('stars-bar').getBoundingClientRect();
      setTimeout(() => {
        star.style.left = target.left + 'px';
        star.style.top = target.top + 'px';
        star.style.transform = 'scale(0.5)';
        star.style.opacity = '0';
      }, 50);

      setTimeout(() => { star.remove(); stars++; aggiornaStelleVisive(); }, 850);
    }

    function animatePoop(btn) {
      const poop = document.createElement('div');
      poop.className = 'exploding-poop';
      poop.innerText = 'üí©';
      const rect = btn.getBoundingClientRect();
      poop.style.left = (rect.left + rect.width / 2 - 15) + 'px';
      poop.style.top = (rect.top - 20) + 'px';
      document.body.appendChild(poop);

      stars = Math.max(0, stars - 1);
      aggiornaStelleVisive();
      setTimeout(() => poop.remove(), 650);
    }

    function aggiornaStelleVisive() {
      document.getElementById('stars-count').innerText = stars;
      localStorage.setItem('stars_' + currentSfida.id, stars);
    }

    function chiudiEProsegui() {
      document.getElementById('modal-overlay').style.display = 'none';
      render();
    }

    /* --- REPORT FINALE --- */
    function showReport() {
      document.getElementById('game-screen').style.display = 'none';
      document.getElementById('report-area').style.display = 'block';
     // Titoli report
      document.getElementById("report-title").innerText = t("finalReport");
      document.getElementById("final-stars").innerText = t("totalStars") + ": " + stars;
      
      // Header tabella
      document.getElementById("th-question").innerText = t("reportQuestion");
      document.getElementById("th-correct").innerText = t("reportCorrect");
      document.getElementById("th-attempts").innerText = t("reportAttempts");
      const body = document.getElementById('report-body');
      body.innerHTML = '';

      adventData.forEach(d => {
        const theoryPart = d.spiegazione ? '<span class="theory-text">' + d.spiegazione + '</span>' : '';
        body.innerHTML +=
          '<tr>' +
            '<td>' + d.day + '</td>' +
            '<td>' + d.question + '</td>' +
            '<td>' + d.answerOK + theoryPart + '</td>' +
            '<td>' + (localStorage.getItem('tent_' + currentSfida.id + '_' + d.day) || 1) + '</td>' +
          '</tr>';
      });

      if (window.MathJax) MathJax.typeset();
    }

    /* --- UTILITY --- */
    function parseCSV(csv) {
      return csv.split(/\r?\n/).filter(r => r !== "").map(row => {
        const out = []; let cur = ''; let inQ = false;
        for (let i = 0; i < row.length; i++) {
          let char = row[i];
          if (char === '"') { if (inQ && row[i + 1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
          else if (char === ',' && !inQ) { out.push(cur.trim()); cur = ''; }
          else cur += char;
        }
       out.push(cur.trim()); return out;
      });
    }
// Converte le righe del CSV in oggetti usando la prima riga come header
function rowsToObjects(rows) {
  const headers = rows[0].map(h => (h || "").replace(/^\uFEFF/, "").trim());
  return rows
    .slice(1)
    .filter(r => r.some(cell => (cell || "").trim() !== ""))
    .map(r => {
      const obj = {};
      headers.forEach((h, i) => obj[h] = (r[i] ?? "").trim());
      return obj;
    });
}

    function tornaAlMenu() { location.reload(); }

    function resetGame() {
      if (confirm("Resettare questa sfida?")) {
        adventData.forEach(d => {
          localStorage.removeItem('day_' + currentSfida.id + '_' + d.day);
          localStorage.removeItem('tent_' + currentSfida.id + '_' + d.day);
        });
        localStorage.removeItem('stars_' + currentSfida.id);
        location.reload();
      }
    }

    function resetTutto() {
      if (confirm("Cancellare TUTTO?")) {
        localStorage.clear();
        location.reload();
      }
    }

    window.onload = init;
  </script>
</body>
</html>


